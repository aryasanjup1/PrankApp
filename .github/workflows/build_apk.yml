name: Build APK

on:
  workflow_dispatch:  # Run manually

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Buildozer Dependencies
        run: |
          sudo apt update || true
          sudo apt install -y build-essential git openjdk-17-jdk unzip wget \
                              python3 python3-pip python3-setuptools \
                              libffi-dev libssl-dev liblzma-dev libncurses5 libncursesw5 \
                              zlib1g-dev libgirepository1.0-dev libc6 libstdc++6 \
                              ccache autoconf automake libtool pkg-config \
                              libgl1-mesa-dev libgles2-mesa-dev \
                              libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev \
                              libsdl2-ttf-dev libportmidi-dev ffmpeg \
                              libswscale-dev libavcodec-dev libavformat-dev || true

      - name: Install Buildozer & Dependencies
        run: |
          pip3 install --upgrade pip || true
          pip3 install buildozer cython virtualenv || true

      - name: Initialize Buildozer (Only If Needed)
        run: |
          if [ ! -f buildozer.spec ]; then
            buildozer init || true
          fi

      - name: Fix SDKManager Not Found Error
        run: |
          export ANDROID_SDK_ROOT=$HOME/android-sdk
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
          if ! command -v sdkmanager &> /dev/null; then
            echo "Installing Android SDK Manager..."
            mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O sdk-tools.zip
            unzip -q sdk-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
            mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
            rm sdk-tools.zip
            echo "SDK Manager Installed!"
          else
            echo "SDK Manager Already Installed!"
          fi
          sdkmanager --install "platform-tools" "build-tools;34.0.0" "platforms;android-34" || true

      - name: Build APK
        run: |
          buildozer -v android debug | tee build_error.log || true

      - name: Check If build_error.log Exists
        id: check_error_log
        run: |
          if [ -f build_error.log ]; then
            echo "log_exists=true" >> $GITHUB_ENV
          else
            echo "log_exists=false" >> $GITHUB_ENV
          fi

      - name: Upload Debug Log (if failed)
        if: env.log_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build_error_log
          path: build_error.log

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PrankApp-debug.apk
          path: bin/*.apk
